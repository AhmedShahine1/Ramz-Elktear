name: Build & Deploy Ramz Elktear to Remote IIS (via msdeploy)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows]

    steps:
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ›  Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore "Ramz Elktear/Ramz Elktear.csproj"

    - name: ğŸ”¨ Build
      run: dotnet build "Ramz Elktear/Ramz Elktear.csproj" --no-restore --configuration Release

    - name: ğŸš€ Publish App
      run: dotnet publish "Ramz Elktear/Ramz Elktear.csproj" --configuration Release --output ./publish

    - name: ğŸŒ Deploy using MSDeploy
      shell: powershell
      run: |
        $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
        & $msdeploy `
          -verb:sync `
          -source:contentPath="${{ github.workspace }}\publish" `
          -dest:contentPath="controlPanal",computerName="https://92.205.63.170:8172/msdeploy.axd",userName="${{ secrets.DEPLOY_USERNAME }}",password="${{ secrets.DEPLOY_PASSWORD }}",authType="Basic" `
          -allowUntrusted

    - name: âœ… Done
      run: echo "âœ… Deployed to IIS successfully"
