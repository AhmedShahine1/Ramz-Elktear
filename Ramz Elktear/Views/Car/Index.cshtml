@model IEnumerable<CarDTO>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bx bx-car me-2"></i><span class="text-truncate">@Localizer["CarList", "Car"]</span></h5>
        <div>
            <a href="@Url.Action("Create")" class="btn btn-success btn-sm me-2">
                <i class="bx bx-plus me-1"></i><span class="text-truncate">@Localizer["AddNewCar", "Car"]</span>
            </a>
            <a href="@Url.Action("AllCars", "Report")" class="btn btn-info btn-sm">
                <i class="bx bx-file me-1"></i><span class="text-truncate">@Localizer["Report", "Common"]</span>
            </a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>
                            <i class="bx bx-text me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["NameArabic", "Car"]</span>
                        </th>
                        <th>
                            <i class="bx bx-text me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["NameEnglish", "Car"]</span>
                        </th>
                        <th>
                            <i class="bx bx-info-circle me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["DescriptionArabic", "Car"]</span>
                        </th>
                        <th>
                            <i class="bx bx-info-circle me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["DescriptionEnglish", "Car"]</span>
                        </th>
                        <th>
                            <i class="bx bx-money me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["SellingPrice", "Car"]</span>
                        </th>
                        <th>
                            <i class="bx bx-image me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["Image", "Common"]</span>
                        </th>
                        <th>
                            <i class="bx bx-cog me-1"></i>
                            <span class="text-truncate d-inline-block w-100">@Localizer["Actions", "Common"]</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        int index = 1;
                        foreach (var car in Model)
                        {
                            <tr>
                                <td>@index</td>
                                <td>@car.NameAr</td>
                                <td>@car.NameEn</td>
                                <td class="text-truncate" style="max-width: 150px;">@car.DescrptionAr</td>
                                <td class="text-truncate" style="max-width: 150px;">@car.DescrptionEn</td>
                                <td>@car.SellingPrice.ToString("C", new System.Globalization.CultureInfo("ar-SA"))</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(car.ImageUrl))
                                    {
                                        <img src="@car.ImageUrl" alt="@car.NameEn" class="rounded shadow-sm" width="80" height="60" style="object-fit: cover;" />
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted">
                                            <i class="bx bx-image-alt d-block fs-4"></i>
                                            <small>@Localizer["NoImage", "Common"]</small>
                                        </div>
                                    }
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                                            <li>
                                                <a class="dropdown-item d-flex align-items-center" href="@Url.Action("Edit", new { id = car.Id })">
                                                    <i class="bx bx-edit-alt me-2 text-primary"></i><span class="text-truncate">@Localizer["Edit", "Common"]</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item d-flex align-items-center" href="@Url.Action("Details", new { id = car.Id })">
                                                    <i class="bx bx-info-circle me-2 text-info"></i><span class="text-truncate">@Localizer["ViewDetails", "Common"]</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item d-flex align-items-center add-to-offer-btn" href="#"
                                                   data-car-id="@car.Id" data-car-name="@car.NameEn" data-car-price="@car.SellingPrice">
                                                    <i class="bx bx-tag me-2 text-warning"></i><span class="text-truncate">@Localizer["AddToOffer", "Car"]</span>
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <form action="@Url.Action("Delete", new { id = car.Id })" method="post" id="delete-form-@car.Id">
                                                    @Html.AntiForgeryToken()
                                                    <button type="button" class="dropdown-item d-flex align-items-center delete-car-btn"
                                                            data-car-id="@car.Id" data-car-name="@car.NameEn">
                                                        <i class="bx bx-trash me-2 text-danger"></i><span class="text-truncate">@Localizer["Delete", "Common"]</span>
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            index++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bx bx-car-crash fs-1"></i>
                                    <p class="mt-2">@Localizer["NoCarsAvailable", "Car"]</p>
                                    <a href="@Url.Action("Create")" class="btn btn-sm btn-outline-primary mt-2">
                                        <i class="bx bx-plus me-1"></i>@Localizer["AddYourFirstCar", "Car"]
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bx bx-error-circle me-2"></i>@Localizer["ConfirmDeletion", "Common"]
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="@Localizer["Close", "Common"]"></button>
            </div>
            <div class="modal-body py-4">
                <p>@Localizer["AreYouSureDelete", "Common"] <strong id="carNameToDelete"></strong>?</p>
                <p class="text-danger mb-0"><small>@Localizer["ActionCannotBeUndone", "Common"]</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bx bx-x me-1"></i>@Localizer["Cancel", "Common"]
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bx bx-trash me-1"></i>@Localizer["Delete", "Common"]
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add to Offer Modal -->
<div class="modal fade" id="addOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bx bx-tag me-2"></i>@Localizer["AddCarToOffer", "Car"]
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="@Localizer["Close", "Common"]"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="carIdForOffer" />

                <!-- Selected Car Info -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <label class="text-muted small mb-1">@Localizer["SelectedCar", "Car"]</label>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bx bx-car fs-2 text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0" id="carNameDisplay"></h6>
                                <div class="small text-muted">@Localizer["RegularPrice", "Car"]: <span id="carPriceDisplay"></span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Offer Selection -->
                <div class="mb-4">
                    <label for="offerSelect" class="form-label">
                        <i class="bx bx-purchase-tag me-1"></i>@Localizer["SelectOffer", "Car"]
                    </label>
                    <select class="form-select form-select-lg" id="offerSelect">
                        <option value="">-- @Localizer["SelectAnOffer", "Car"] --</option>
                    </select>
                    <div class="invalid-feedback">@Localizer["PleaseSelectOffer", "Car"]</div>
                </div>

                <!-- Price Input -->
                <div class="mb-3">
                    <label for="offerPrice" class="form-label">
                        <i class="bx bx-money me-1"></i>@Localizer["SpecialOfferPrice", "Car"]
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-light">$</span>
                        <input type="number" class="form-control form-control-lg" id="offerPrice" step="0.01" min="0"
                               placeholder="@Localizer["EnterSpecialPrice", "Car"]" />
                    </div>
                    <div class="invalid-feedback">@Localizer["PleaseEnterValidPrice", "Car"]</div>
                    <div class="form-text mt-2 d-flex align-items-center">
                        <i class="bx bx-info-circle me-1"></i>
                        <span id="discountMessage">@Localizer["EnterSpecialPriceMessage", "Car"]</span>
                    </div>
                </div>

                <!-- Progress indicator - Hidden by default -->
                <div id="offerSaveProgress" class="progress mt-4 d-none">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                         role="progressbar" style="width: 100%"></div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bx bx-x me-1"></i>@Localizer["Cancel", "Common"]
                </button>
                <button type="button" class="btn btn-primary" id="saveOfferBtn">
                    <i class="bx bx-check me-1"></i>@Localizer["Save", "Common"]
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        $(document).ready(function() {
            // Localized messages for JavaScript
            const localizedMessages = {
                loadingOffers: '@Html.Raw(Localizer["LoadingOffers", "Car"])',
                selectAnOffer: '@Html.Raw(Localizer["SelectAnOffer", "Car"])',
                noOffersAvailable: '@Html.Raw(Localizer["NoOffersAvailable", "Car"])',
                noOffersAvailableMessage: '@Html.Raw(Localizer["NoOffersAvailableMessage", "Car"])',
                failedToLoadOffers: '@Html.Raw(Localizer["FailedToLoadOffers", "Car"])',
                failedToLoadOffersMessage: '@Html.Raw(Localizer["FailedToLoadOffersMessage", "Car"])',
                saving: '@Html.Raw(Localizer["Saving", "Common"])',
                carAddedToOfferSuccess: '@Html.Raw(Localizer["CarAddedToOfferSuccess", "Car"])',
                failedToAddCarToOffer: '@Html.Raw(Localizer["FailedToAddCarToOffer", "Car"])',
                errorOccurred: '@Html.Raw(Localizer["ErrorOccurred", "Common"])',
                enterSpecialPriceMessage: '@Html.Raw(Localizer["EnterSpecialPriceMessage", "Car"])',
                youreOfferingDiscount: '@Html.Raw(Localizer["YoureOfferingDiscount", "Car"])',
                save: '@Html.Raw(Localizer["Save", "Car"])',
                priceHigherThanRegular: '@Html.Raw(Localizer["PriceHigherThanRegular", "Car"])',
                noDiscountApplied: '@Html.Raw(Localizer["NoDiscountApplied", "Car"])'
            };

            // Configure toastr notification
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: "toast-top-right",
                timeOut: 3000
            };

            // Click handler for "Add to Offer" button
            $('.add-to-offer-btn').on('click', function(e) {
                e.preventDefault();
                const carId = $(this).data('car-id');
                const carName = $(this).data('car-name');
                const carPrice = $(this).data('car-price');
                const formattedPrice = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(carPrice);

                $('#carIdForOffer').val(carId);
                $('#carNameDisplay').text(carName);
                $('#carPriceDisplay').text(formattedPrice);

                // Calculate a suggested offer price (10% discount as default)
                const suggestedPrice = carPrice * 0.9;
                $('#offerPrice').val(suggestedPrice.toFixed(2));
                updateDiscountMessage(carPrice, suggestedPrice);

                // Reset validation styling
                $('#offerSelect').removeClass('is-invalid');
                $('#offerPrice').removeClass('is-invalid');

                // Fetch offers and populate dropdown
                fetchOffers();
            });

            // Price input change handler to show discount percentage
            $('#offerPrice').on('input', function() {
                const regularPrice = parseFloat($('.add-to-offer-btn[data-car-id="' + $('#carIdForOffer').val() + '"]').data('car-price'));
                const offerPrice = parseFloat($(this).val());

                if (!isNaN(regularPrice) && !isNaN(offerPrice) && regularPrice > 0) {
                    updateDiscountMessage(regularPrice, offerPrice);
                }
            });

            // Helper function to update discount message
            function updateDiscountMessage(regularPrice, offerPrice) {
                if (regularPrice > 0 && offerPrice > 0) {
                    const discountPercent = ((regularPrice - offerPrice) / regularPrice * 100).toFixed(1);
                    const discountAmount = (regularPrice - offerPrice).toFixed(2);

                    if (discountPercent > 0) {
                        $('#discountMessage').html(localizedMessages.youreOfferingDiscount.replace('{0}', discountPercent).replace('{1}', discountAmount));
                    } else if (discountPercent < 0) {
                        $('#discountMessage').html(localizedMessages.priceHigherThanRegular.replace('{0}', Math.abs(discountPercent)));
                    } else {
                        $('#discountMessage').html(localizedMessages.noDiscountApplied);
                    }
                } else {
                    $('#discountMessage').html(localizedMessages.enterSpecialPriceMessage);
                }
            }

            // Function to fetch offers
            function fetchOffers() {
                $.ajax({
                    url: '@Url.Action("GetAllOffers", "Car")',
                    type: 'GET',
                    beforeSend: function() {
                        $('#offerSelect').html('<option value="">' + localizedMessages.loadingOffers + '</option>');
                    },
                    success: function(response) {
                        $('#offerSelect').empty();
                        $('#offerSelect').append('<option value="">-- ' + localizedMessages.selectAnOffer + ' --</option>');

                        if (response.status) {
                            const offers = response.data;
                            if (offers && offers.length > 0) {
                                offers.forEach(function(offer) {
                                    $('#offerSelect').append(`<option value="${offer.id}">${offer.nameEn}</option>`);
                                });

                                // Show the modal after offers are loaded
                                $('#addOfferModal').modal('show');
                            } else {
                                $('#offerSelect').append('<option value="" disabled>' + localizedMessages.noOffersAvailable + '</option>');
                                $('#addOfferModal').modal('show');
                                toastr.warning(localizedMessages.noOffersAvailableMessage);
                            }
                        } else {
                            toastr.error(response.ErrorMessage || localizedMessages.failedToLoadOffers);
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = localizedMessages.failedToLoadOffersMessage;

                        if (xhr && xhr.responseJSON) {
                            errorMessage = xhr.responseJSON.ErrorMessage || errorMessage;
                        }

                        console.error('Error fetching offers:', xhr);
                        toastr.error(errorMessage);
                    }
                });
            }

            // Save button click handler
            $('#saveOfferBtn').on('click', function() {
                const carId = $('#carIdForOffer').val();
                const offerId = $('#offerSelect').val();
                const sellingPrice = $('#offerPrice').val();
                let isValid = true;

                // Validate offer selection
                if (!offerId) {
                    $('#offerSelect').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#offerSelect').removeClass('is-invalid');
                }

                // Validate price
                if (!sellingPrice || parseFloat(sellingPrice) <= 0) {
                    $('#offerPrice').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#offerPrice').removeClass('is-invalid');
                }

                if (!isValid) return;

                // Show loading state
                const saveBtn = $('#saveOfferBtn');
                const originalHtml = saveBtn.html();
                saveBtn.html('<i class="bx bx-loader bx-spin me-1"></i> ' + localizedMessages.saving + '...');
                saveBtn.prop('disabled', true);
                $('#offerSaveProgress').removeClass('d-none');

                // Prepare data object
                const requestData = {
                    carId: carId,
                    offerId: offerId,
                    sellingPrice: parseFloat(sellingPrice)
                };

                // Send AJAX request to add car to offer
                $.ajax({
                    url: '@Url.Action("AddCarOffer", "Car")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        // Reset button state
                        saveBtn.html(originalHtml);
                        saveBtn.prop('disabled', false);
                        $('#offerSaveProgress').addClass('d-none');

                        // Handle BaseResponse format
                        if (response && response.status) {
                            toastr.success(response.ErrorMessage || localizedMessages.carAddedToOfferSuccess);
                            $('#addOfferModal').modal('hide');

                            // Reset form fields
                            $('#offerSelect').val('');
                            $('#offerPrice').val('');
                        } else {
                            toastr.error(response.ErrorMessage || localizedMessages.failedToAddCarToOffer);
                        }
                    },
                    error: function(xhr, status, error) {
                        // Reset button state
                        saveBtn.html(originalHtml);
                        saveBtn.prop('disabled', false);
                        $('#offerSaveProgress').addClass('d-none');

                        let errorMessage = localizedMessages.errorOccurred;

                        // Try to extract error message from response
                        if (xhr && xhr.responseJSON) {
                            errorMessage = xhr.responseJSON.ErrorMessage || errorMessage;
                        }

                        console.error('Error adding car to offer:', xhr);
                        toastr.error(errorMessage);
                    }
                });
            });

            // Delete car button click handler
            $('.delete-car-btn').on('click', function(e) {
                e.preventDefault();
                const carId = $(this).data('car-id');
                const carName = $(this).data('car-name');

                $('#carNameToDelete').text(carName);
                $('#deleteConfirmModal').modal('show');

                // Set up the confirm delete button
                $('#confirmDeleteBtn').off('click').on('click', function() {
                    $(`#delete-form-${carId}`).submit();
                });
            });

            // Reset modals when closed
            $('#addOfferModal').on('hidden.bs.modal', function() {
                $('#offerSelect').val('');
                $('#offerPrice').val('');
                $('#offerSelect').removeClass('is-invalid');
                $('#offerPrice').removeClass('is-invalid');
                $('#discountMessage').html(localizedMessages.enterSpecialPriceMessage);
            });
        });
    </script>
}